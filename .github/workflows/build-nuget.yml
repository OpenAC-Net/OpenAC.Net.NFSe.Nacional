# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: ğŸ“¦ Build Custom NuGet Package

on:
  # ğŸ¯ Manual execution with custom version suffix
  workflow_dispatch:
    inputs:
      version_suffix:
        description: 'Version suffix (e.g., fork, custom, test)'
        required: false
        default: 'fork'
        type: string
  
  # ğŸš€ Automatic on push to main and version tags
  push:
    branches:
      - main
    tags:
      - 'v*'

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true
  BASE_VERSION: '1.4.1'

jobs:
  build:
    name: ğŸ”¨ Build and Package
    runs-on: ubuntu-latest
    
    steps:
      # ğŸ“¥ Checkout code with full history
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # âš™ï¸ Setup .NET SDK (multiple versions)
      - name: âš™ï¸ Setup .NET
        uses: actions/setup-dotnet@v5.0.0
        with:
          dotnet-version: |
            8.0.x
            9.0.x
            10.0.x
      
      # ğŸ“¦ Restore dependencies
      - name: ğŸ“¦ Restore dependencies
        run: dotnet restore src/OpenAC.Net.NFSe.Nacional.sln
      
      # ğŸ”¨ Build solution
      - name: ğŸ”¨ Build solution
        run: dotnet build src/OpenAC.Net.NFSe.Nacional.sln -c Release --no-restore
      
      # ğŸ¯ Determine version
      - name: ğŸ¯ Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Tag version: v1.5.0 -> 1.5.0
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ Version from tag: $VERSION"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual execution: 1.4.1-{suffix}.{run_number}
            VERSION="${{ env.BASE_VERSION }}-${{ inputs.version_suffix }}.${{ github.run_number }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ Version from manual input: $VERSION"
          else
            # Push to main: 1.4.1-fork.{run_number}
            VERSION="${{ env.BASE_VERSION }}-fork.${{ github.run_number }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ Version from push: $VERSION"
          fi
      
      # ğŸ“¦ Pack NuGet with custom properties
      - name: ğŸ“¦ Pack NuGet package
        run: |
          dotnet pack src/OpenAC.Net.NFSe.Nacional/OpenAC.Net.NFSe.Nacional.csproj \
            -c Release \
            --no-build \
            -o ./artifacts \
            /p:PackageId=RenatoGuarilha.OpenAC.Net.NFSe.Nacional \
            /p:Version=${{ steps.version.outputs.version }} \
            /p:Authors="Renato Guarilha" \
            /p:Company="Renato Guarilha" \
            /p:RepositoryUrl=https://github.com/${{ github.repository }} \
            /p:PackageProjectUrl=https://github.com/${{ github.repository }} \
            /p:PackageTags="OpenAC.Net NFSe Nacional OpenNFSe Fork"
      
      # ğŸ“¤ Upload .nupkg artifacts
      - name: ğŸ“¤ Upload NuGet package
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: ./artifacts/*.nupkg
          retention-days: 90
          if-no-files-found: error
      
      # ğŸ“¤ Upload .snupkg artifacts (symbols)
      - name: ğŸ“¤ Upload symbols package
        uses: actions/upload-artifact@v4
        with:
          name: nuget-symbols
          path: ./artifacts/*.snupkg
          retention-days: 90
          if-no-files-found: warn
      
      # ğŸ“Š Create summary
      - name: ğŸ“Š Create summary
        run: |
          echo "## ğŸ“¦ NuGet Package Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Œ **Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ **Package ID:** \`RenatoGuarilha.OpenAC.Net.NFSe.Nacional\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¥ Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the artifact from this workflow run and install locally:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Install from local .nupkg file" >> $GITHUB_STEP_SUMMARY
          echo "dotnet add package RenatoGuarilha.OpenAC.Net.NFSe.Nacional --source /path/to/nupkg/folder" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Or configure a local NuGet source:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Add local source" >> $GITHUB_STEP_SUMMARY
          echo "dotnet nuget add source /path/to/nupkg/folder --name LocalFork" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Install package" >> $GITHUB_STEP_SUMMARY
          echo "dotnet add package RenatoGuarilha.OpenAC.Net.NFSe.Nacional --version ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Package Contents" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¦ Main package: \`RenatoGuarilha.OpenAC.Net.NFSe.Nacional.${{ steps.version.outputs.version }}.nupkg\`" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” Symbols: \`RenatoGuarilha.OpenAC.Net.NFSe.Nacional.${{ steps.version.outputs.version }}.snupkg\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â„¹ï¸ About this Package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This is a custom fork of OpenAC.Net.NFSe.Nacional with personalized metadata." >> $GITHUB_STEP_SUMMARY
          echo "The original project can be found at: https://github.com/OpenAC-Net/OpenAC.Net.NFSe.Nacional" >> $GITHUB_STEP_SUMMARY

  release:
    name: ğŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    # Only run on tags
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
      # ğŸ“¥ Download NuGet package artifact
      - name: ğŸ“¥ Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: ./artifacts
      
      # ğŸ“¥ Download symbols artifact
      - name: ğŸ“¥ Download symbols package
        uses: actions/download-artifact@v4
        with:
          name: nuget-symbols
          path: ./artifacts
        continue-on-error: true
      
      # ğŸš€ Create GitHub Release
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./artifacts/*
          generate_release_notes: true
          draft: false
          prerelease: false
